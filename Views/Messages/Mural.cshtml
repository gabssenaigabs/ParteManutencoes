@model IEnumerable<CondoHub.Models.ViewModels.AvisoMuralViewModel>
@{
    var avisoNovo = new CondoHub.Models.Entities.Messages();
}
@{
    ViewData["Title"] = "Mural de Avisos";
}

@if (User?.Identity != null && User.Identity.IsAuthenticated)
{
    <partial name="_Sidebar" />
}
<style>
    .avisos-header {
        position: fixed;
        top: 0;
        left: 250px;
        height: 120px;
        width: calc(100% - 250px);
        background: linear-gradient(90deg, #32c6e6 0%, #007cf0 100%);
        background-size: cover;
        padding: 25px 0 25px 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
        box-shadow: inset 0 -20px 40px rgba(0, 0, 0, 0.06);
    }

    .main-content {
        margin-left: 250px;
        margin-top: 120px;
        position: relative;
        z-index: 1;
    }

    .avisos-list {
        gap: 28px !important;
    }

    .aviso-card {
        min-height: 160px;
        border-radius: 20px !important;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    keyframes modalShowAviso {
        from {
            opacity: 0;
            transform: translateY(40px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
<div class="avisos-header">
    <div class="d-flex justify-content-between align-items-center w-100" style="height: 100%;">
        <div class="d-flex align-items-center gap-3">
            <i class="bi bi-bell" style="font-size: 36px; color: white;"></i>
            <div>
                <h1 class="mb-0 text-white fw-bold" style="font-size: 32px; line-height: 1;">Mural de Avisos</h1>
                <p class="mb-0 text-white" style="font-size: 14px; opacity: 0.9;">Comunicados e avisos para todos os
                    moradores</p>
            </div>
        </div>
        <a href="/Messages/CriarAviso" class="btn d-inline-flex align-items-center"
            style="background: #fff; color: #007cf0; border: none; min-width: 140px; font-weight: 500; font-size: 16px; margin-right: 36px; text-decoration:none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                stroke="#007cf0" stroke-width="2" style="margin-right: 6px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Novo Aviso
        </a>
    </div>
</div>

<div id="modalNovoAviso" class="modal-aviso-overlay" style="display:none;">
    <div class="modal-aviso-card">
        <div class="modal-aviso-header">
            <span class="modal-aviso-title">Criar Novo Aviso</span>
            <button type="button" class="close-modal-aviso" id="fecharModalAviso" aria-label="Fechar">&times;</button>
        </div>
        <div class="modal-aviso-subtitle">Publique um comunicado para todos os moradores</div>
        @using (Html.BeginForm("CriarAviso", "Messages", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(m => avisoNovo.Id)
            <div class="form-group">
                <label for="Titulo">Título</label>
                @Html.TextBoxFor(m => avisoNovo.Titulo, new { @class = "form-control", placeholder = "Título do aviso" })
                @Html.ValidationMessageFor(m => avisoNovo.Titulo, "", new { @class = "text-danger" })
            </div>
            <div class="form-group">
                <label for="Mensagem">Mensagem</label>
                @Html.TextAreaFor(m => avisoNovo.Mensagem, new { @class = "form-control", placeholder = "Escreva o            comunicado aqui..." })
                @Html.ValidationMessageFor(m => avisoNovo.Mensagem, "", new { @class = "text-danger" })
            </div>
            <div class="form-group">
                <label>Tipo de Aviso</label>
                @Html.DropDownListFor(m => avisoNovo.Tipo, Html.GetEnumSelectList<CondoHub.Models.Entities.TipoAviso>(), new
                { @class = "form-control" })
            @Html.ValidationMessageFor(m => avisoNovo.Tipo, "", new { @class = "text-danger" })
        </div>
        <div class="form-group">
            <label for="ImagemPath">Adicionar imagem</label>
            <input type="file" name="ImagemPath" class="form-control" />
        </div>
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" id="cancelarModalAviso">Cancelar</button>
            <button type="submit" class="btn btn-primary">Publicar</button>
        </div>
                }
    </div>
</div>

<div class="main-content">
    @if (Model != null && Model.Any())
    {
        <div class="avisos-list d-flex flex-column gap-4">
            @foreach (var aviso in Model.OrderByDescending(a => a.DataPublicacao))
            {
                <div class="aviso-card bg-white shadow-sm rounded-4 mx-auto" style="width:700px; max-width:96vw;">
                    <div class="d-flex align-items-center p-3 pb-0" style="position:relative;">
                        <div class="aviso-avatar me-3"
                            style="width:48px; height:48px; border-radius:50%; background:#e3edff; display:flex; align-items:center; justify-content:center; font-weight:600; color:#4a6cf7; font-size:1.2rem;">
                            <span class="fw-bold">@((aviso.UsuarioNome ?? "U").Substring(0, Math.Min(2, (aviso.UsuarioNome ??
                                                        "U").Length)).ToUpper())</span>
                        </div>
                        <div class="d-flex flex-column">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-weight:500; font-size:16px;">@aviso.UsuarioNome</span>
                                <span
                                    style="background:#f0f0f0; color:#333; font-size:12px; font-weight:500; padding:4px 12px; border-radius:6px; white-space:nowrap;">@aviso.UsuarioTipo</span>
                            </div>
                            <div style="font-size:13px; color:#888; margin-top:2px;">@aviso.DataPublicacao.ToString("dd/MM/yy                    'às' HH:mm")</div>
                        </div>
                        <div style="position:absolute;top:8px;right:16px;">
                            <span class="badge aviso-tipo"
                                style="background:@GetTipoCor(aviso.Tipo); color:#fff; font-size:0.95em; padding:6px 18px; border-radius:8px;">@aviso.Tipo</span>
                        </div>
                    </div>
                    <div class="px-3 pt-2 pb-3">
                        <div class="fw-semibold" style="font-size:1.15rem;">@aviso.Titulo</div>
                        <div class="text-dark" style="font-size:1rem; margin-bottom:12px;">@aviso.Mensagem</div>
                    </div>
                    @if (!string.IsNullOrEmpty(aviso.ImagemPath))
                    {
                        <div class="aviso-img-area" style="width:100%; height:300px; overflow:hidden; border-radius:0 0 20px 20px;">
                            <img src="~/uploads/@aviso.ImagemPath" alt="Imagem do aviso"
                                style="width:100%; height:100%; display:block; object-fit:cover;" />
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center text-muted mt-5">Nenhum aviso publicado ainda.</div>
    }
</div>

@functions {
    public string GetTipoCor(string tipo)
    {
        return tipo switch
        {
            "Evento" => "#2979ff",
            "Comunicado" => "#00c853",
            "Aviso" => "#f44336",
            "Manutenção" => "#ff9800",
            _ => "#888"
        };
    }
}